---
/**
 * å¯†ç ä¿æŠ¤é—¨ç¦ç»„ä»¶
 * ç”¨äºåœ¨é¡µé¢ä¸­æ˜¾ç¤ºå¯†ç è¾“å…¥è¡¨å•ï¼ŒéªŒè¯é€šè¿‡åæ˜¾ç¤ºå†…å®¹
 */
import { verifyPassword, isPasswordVerified, savePasswordVerification, type PasswordConfig } from '../lib/password-protection';
import type { Lang } from '../i18n/config';

interface Props {
	/** æ­£ç¡®çš„å¯†ç  */
	password: string;
	/** è¯­è¨€ */
	lang?: Lang;
	/** å­˜å‚¨é”®åï¼ˆç”¨äºåŒºåˆ†ä¸åŒé¡µé¢çš„å¯†ç ï¼‰ */
	storageKey?: string;
	/** å¯†ç æœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰ï¼Œ0 è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ */
	expiresIn?: number;
	/** æ˜¯å¦ä½¿ç”¨ sessionStorage */
	useSessionStorage?: boolean;
	/** æç¤ºæ–‡æœ¬ */
	hint?: string;
	/** é”™è¯¯æç¤ºæ–‡æœ¬ */
	errorText?: string;
	/** æˆåŠŸæç¤ºæ–‡æœ¬ */
	successText?: string;
}

const {
	password: correctPassword,
	lang = 'zh',
	storageKey = 'page_password_verified',
	expiresIn = 0,
	useSessionStorage = false,
	hint,
	errorText,
	successText,
} = Astro.props;

const config: PasswordConfig = {
	password: correctPassword,
	storageKey,
	expiresIn,
	useSessionStorage,
};

const isVerified = isPasswordVerified(config);

const defaultHint = lang === 'zh' 
	? 'è¯·è¾“å…¥å¯†ç ä»¥è®¿é—®æ­¤é¡µé¢' 
	: 'Please enter password to access this page';
const defaultError = lang === 'zh'
	? 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•'
	: 'Incorrect password, please try again';
const defaultSuccess = lang === 'zh'
	? 'éªŒè¯æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...'
	: 'Verification successful, redirecting...';
---

{isVerified ? (
	<slot />
) : (
	<div class="password-gate">
		<div class="password-gate-container">
			<div class="password-gate-content">
				<h2>{lang === 'zh' ? 'ğŸ”’ å¯†ç ä¿æŠ¤' : 'ğŸ”’ Password Protected'}</h2>
				<p class="password-gate-hint">
					{hint || defaultHint}
				</p>
				<form class="password-gate-form" id="password-form">
					<input
						type="password"
						id="password-input"
						class="password-gate-input"
						placeholder={lang === 'zh' ? 'è¯·è¾“å…¥å¯†ç ' : 'Enter password'}
						autocomplete="off"
						required
					/>
					<button type="submit" class="password-gate-button">
						{lang === 'zh' ? 'éªŒè¯' : 'Verify'}
					</button>
				</form>
				<div id="password-error" class="password-gate-error" style="display: none;"></div>
			</div>
		</div>
	</div>
)}

<style>
	.password-gate {
		min-height: 60vh;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2rem;
	}

	.password-gate-container {
		width: 100%;
		max-width: 400px;
	}

	.password-gate-content {
		background: var(--bg-card, #fff);
		border: 1px solid var(--border, #e0e0e0);
		border-radius: 8px;
		padding: 2rem;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.password-gate-content h2 {
		margin: 0 0 1rem 0;
		font-size: 1.5rem;
		text-align: center;
	}

	.password-gate-hint {
		margin: 0 0 1.5rem 0;
		color: var(--text-secondary, #666);
		text-align: center;
		font-size: 0.9rem;
	}

	.password-gate-form {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.password-gate-input {
		padding: 0.75rem;
		border: 1px solid var(--border, #e0e0e0);
		border-radius: 4px;
		font-size: 1rem;
		background: var(--bg, #fff);
		color: var(--text, #000);
	}

	.password-gate-input:focus {
		outline: none;
		border-color: var(--accent, #0066cc);
	}

	.password-gate-button {
		padding: 0.75rem 1.5rem;
		background: var(--accent, #0066cc);
		color: white;
		border: none;
		border-radius: 4px;
		font-size: 1rem;
		cursor: pointer;
		transition: background 0.2s;
	}

	.password-gate-button:hover {
		background: var(--accent-hover, #0052a3);
	}

	.password-gate-button:active {
		transform: scale(0.98);
	}

	.password-gate-error {
		margin-top: 1rem;
		padding: 0.75rem;
		background: var(--error-bg, #fee);
		color: var(--error-text, #c00);
		border-radius: 4px;
		text-align: center;
		font-size: 0.9rem;
	}

	[data-theme="dark"] .password-gate-content {
		background: var(--bg-card, #1a1a1a);
		border-color: var(--border, #333);
	}

	[data-theme="dark"] .password-gate-input {
		background: var(--bg, #1a1a1a);
		color: var(--text, #fff);
		border-color: var(--border, #333);
	}
</style>

<script define:vars={{ correctPassword, storageKey, expiresIn, useSessionStorage, defaultError, defaultSuccess, lang }}>
	import { verifyPassword, savePasswordVerification } from '../lib/password-protection';

	const form = document.getElementById('password-form') as HTMLFormElement;
	const input = document.getElementById('password-input') as HTMLInputElement;
	const errorDiv = document.getElementById('password-error') as HTMLDivElement;

	if (form && input) {
		form.addEventListener('submit', (e) => {
			e.preventDefault();
			
			const inputPassword = input.value;
			
			if (verifyPassword(inputPassword, correctPassword)) {
				// å¯†ç æ­£ç¡®ï¼Œä¿å­˜éªŒè¯çŠ¶æ€
				savePasswordVerification({
					password: correctPassword,
					storageKey,
					expiresIn,
					useSessionStorage,
				});
				
				// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
				errorDiv.textContent = defaultSuccess;
				errorDiv.style.display = 'block';
				errorDiv.style.background = 'var(--success-bg, #efe)';
				errorDiv.style.color = 'var(--success-text, #0a0)';
				
				// åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºå†…å®¹
				setTimeout(() => {
					window.location.reload();
				}, 500);
			} else {
				// å¯†ç é”™è¯¯
				errorDiv.textContent = defaultError;
				errorDiv.style.display = 'block';
				errorDiv.style.background = 'var(--error-bg, #fee)';
				errorDiv.style.color = 'var(--error-text, #c00)';
				input.value = '';
				input.focus();
			}
		});

		// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
		input.focus();
	}
</script>
