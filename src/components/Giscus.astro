---
import type { Lang } from '../i18n/config';

const { lang = 'zh' } = Astro.props as { lang?: Lang };
const repo = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY;
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;

const isConfigured = !!(repo && repoId && category && categoryId);

// 将 lang 转换为 Giscus 支持的语言代码
const giscusLang = lang === 'zh' ? 'zh-CN' : 'en';
---

{isConfigured ? (
	<section id="giscus-container" style="margin-top: 32px;">
		<script
			src="https://giscus.app/client.js"
			data-repo={repo}
			data-repo-id={repoId}
			data-category={category}
			data-category-id={categoryId}
			data-mapping="pathname"
			data-strict="0"
			data-reactions-enabled="1"
			data-emit-metadata="0"
			data-input-position="top"
			data-theme="preferred_color_scheme"
			data-lang={giscusLang}
			data-loading="lazy"
			crossorigin="anonymous"
			async
		></script>
		<script is:inline>
			// 错误处理和加载状态
			(function() {
				const container = document.getElementById('giscus-container');
				if (!container) return;

				// 监听 Giscus 加载错误
				window.addEventListener('error', function(e) {
					if (e.target && e.target.src && e.target.src.includes('giscus.app')) {
						console.error('[Giscus] 加载失败:', e);
						container.innerHTML = '<p style="color: var(--text-muted); font-size: 14px; text-align: center; padding: 20px;">评论功能暂时无法加载，请稍后重试或检查网络连接。</p>';
					}
				}, true);

				// 检查 Giscus 是否成功加载
				setTimeout(function() {
					const giscusFrame = container.querySelector('iframe');
					if (!giscusFrame) {
						console.warn('[Giscus] 评论框未加载，可能是 CSP 限制或网络问题');
					}
				}, 3000);
			})();
		</script>
	</section>
) : (
	<script is:inline define:vars={{ isConfigured }}>
		// 仅在控制台输出日志，不显示在页面上
		if (typeof console !== 'undefined' && !isConfigured) {
			console.log('[Giscus] 评论功能未启用：缺少必要的环境变量配置');
			console.log('[Giscus] 需要配置：PUBLIC_GISCUS_REPO, PUBLIC_GISCUS_REPO_ID, PUBLIC_GISCUS_CATEGORY, PUBLIC_GISCUS_CATEGORY_ID');
		}
	</script>
)}
