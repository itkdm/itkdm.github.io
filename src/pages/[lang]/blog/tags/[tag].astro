---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import type { Lang } from '../../../../i18n/config';
import { SUPPORTED_LANGS } from '../../../../i18n/config';
import { sortBlogPosts } from '../../../../lib/blog-sort';

export async function getStaticPaths() {
	const posts = await getCollection('blog', (entry) => !entry.data.draft);
	const paths = [];
	const seenTags = new Set<string>();
	for (const post of posts) {
		for (const tag of post.data.tags) {
			// Use raw tag as route param; avoid special characters like "/" in tags themselves.
			const key = `${post.data.lang}:${tag}`;
			if (!seenTags.has(key)) {
				seenTags.add(key);
				paths.push({ params: { lang: post.data.lang, tag } });
			}
		}
	}
	return paths;
}

const { lang, tag } = Astro.params as { lang: Lang; tag: string };
const encodedTag = encodeURIComponent(tag);
const allPosts = await getCollection('blog', (entry) => entry.data.lang === lang && !entry.data.draft);
const posts = sortBlogPosts(
	allPosts
		.map((entry) => {
			// Use frontmatter slug if available, otherwise extract filename from entry.slug
			const slug = entry.data.slug ?? entry.slug.split('/').pop() ?? entry.slug;
			return { ...entry, slug };
		})
		.filter((p) => p.data.tags.includes(tag))
);

// 获取所有相关标签（出现在这些文章中的其他标签）
const relatedTags = new Map<string, number>();
for (const post of posts) {
	for (const t of post.data.tags) {
		if (t !== tag) {
			relatedTags.set(t, (relatedTags.get(t) ?? 0) + 1);
		}
	}
}
const relatedTagsList = Array.from(relatedTags.entries())
	.sort((a, b) => b[1] - a[1])
	.slice(0, 20); // 最多显示20个相关标签
---

<BaseLayout
	lang={lang}
	title={`${tag} · ${lang === 'zh' ? '标签' : 'Tag'}`}
	description={lang === 'zh' ? '标签归档' : 'Tag archive'}
	currentPath={`/${lang}/blog/tags/${encodedTag}/`}
>
	<section class="section">
		<div class="section-head">
			<div>
				<div class="tag-page-nav" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
					<a 
						href={`/${lang}/blog/`} 
						class="tag-nav-link"
					>
						← {lang === 'zh' ? '返回博客' : 'Back to Blog'}
					</a>
					<span style="color: var(--text-faint);">·</span>
					<a 
						href={`/${lang}/blog/tags/`} 
						class="tag-nav-link"
					>
						{lang === 'zh' ? '所有标签' : 'All Tags'}
					</a>
				</div>
				<h2 style="margin: 0 0 8px 0;">
					<span class="tag accent" style="margin-right: 10px; font-size: 14px; padding: 6px 12px;">{tag}</span>
					{lang === 'zh' ? '标签文章' : 'Tagged Posts'}
				</h2>
			</div>
			<p class="faint">{lang === 'zh' ? `共 ${posts.length} 篇文章` : `${posts.length} posts`}</p>
		</div>

		{relatedTagsList.length > 0 && (
			<div class="related-tags-section" style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
				<div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px; font-weight: 500;">
					{lang === 'zh' ? '相关标签' : 'Related Tags'}:
				</div>
				<div style="display: flex; flex-wrap: wrap; gap: 8px;">
					{relatedTagsList.map(([relatedTag, count]) => (
						<a
							href={`/${lang}/blog/tags/${encodeURIComponent(relatedTag)}/`}
							class="tag"
							title={lang === 'zh' ? `${relatedTag} (${count} 篇文章)` : `${relatedTag} (${count} posts)`}
						>
							{relatedTag} <span style="opacity: 0.7; font-size: 11px;">({count})</span>
						</a>
					))}
				</div>
			</div>
		)}

		{posts.length === 0 ? (
			<p class="faint">{lang === 'zh' ? '暂无该标签文章。' : 'No posts with this tag.'}</p>
		) : (
			<div class="grid grid-3">
				{posts.map((post) => (
					<div
						class="card blog-card"
						data-slug={post.slug}
						data-lang={lang}
						role="link"
						tabindex="0"
						aria-label={post.data.title}
						style="cursor: pointer;"
					>
						<div class="badge">Blog</div>
						<h3>{post.data.title}</h3>
						<p class="meta">
							<time datetime={post.data.date.toISOString()}>{post.data.date.toISOString().slice(0, 10)}</time>
						</p>
						<p>{post.data.summary}</p>
						{post.data.tags.length > 0 && (
							<div class="blog-tags-container">
								{post.data.tags.map((t) => (
									<a
										href={`/${lang}/blog/tags/${encodeURIComponent(t)}/`}
										class={`tag ${t === tag ? 'accent' : ''}`}
										title={lang === 'zh' ? `查看所有「${t}」标签的文章` : `View all posts tagged "${t}"`}
									>
										{t}
									</a>
								))}
							</div>
						)}
					</div>
				))}
			</div>
		)}
	</section>

	<style>
		.tag-page-nav .tag-nav-link {
			font-size: 14px;
			color: var(--text-muted);
			text-decoration: none;
			display: flex;
			align-items: center;
			gap: 4px;
			transition: color 0.2s ease;
		}
		.tag-page-nav .tag-nav-link:hover {
			color: var(--primary);
		}
		.related-tags-section {
			scroll-margin-top: 20px;
		}
	</style>

	<script>
		// 防止标签链接触发卡片链接
		document.addEventListener('DOMContentLoaded', () => {
			document.querySelectorAll('.blog-card[data-slug]').forEach((card) => {
				const slug = card.dataset.slug;
				const lang = card.dataset.lang;
				card.addEventListener('click', (e) => {
					if (e.target.closest('.blog-tags-container')) {
						return;
					}
					window.location.href = `/${lang}/blog/${slug}/`;
				});
				card.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' || e.key === ' ') {
						e.preventDefault();
						card.click();
					}
				});
			});

			const tagLinks = document.querySelectorAll('.blog-tags-container .tag');
			tagLinks.forEach((link) => {
				link.addEventListener('click', (e) => {
					e.stopPropagation();
				});
			});
		});
	</script>
</BaseLayout>
