---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import type { Lang } from '../../../i18n/config';
import { SUPPORTED_LANGS } from '../../../i18n/config';
import { sortBlogPosts } from '../../../lib/blog-sort';

export function getStaticPaths() {
	return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params as { lang: Lang };
const posts = sortBlogPosts(
	(await getCollection('blog', (entry) => entry.data.lang === lang && !entry.data.draft))
		.map((entry) => {
			// Use frontmatter slug if available, otherwise extract filename from entry.slug
			const slug = entry.data.slug ?? entry.slug.split('/').pop() ?? entry.slug;
			return { ...entry, slug };
		})
);

const byYear = new Map<number, typeof posts>();
for (const post of posts) {
	const year = post.data.date.getFullYear();
	if (!byYear.has(year)) byYear.set(year, []);
	byYear.get(year)?.push(post);
}
const archive = Array.from(byYear.entries()).sort((a, b) => b[0] - a[0]);
---

<BaseLayout
	lang={lang}
	title={lang === 'zh' ? '归档' : 'Archive'}
	description={lang === 'zh' ? '按年份归档' : 'Yearly archive'}
	currentPath={`/${lang}/blog/archive/`}
>
	<section class="section">
		<div class="section-head">
			<h2>{lang === 'zh' ? '文章归档' : 'Archive'}</h2>
			<p class="faint">{lang === 'zh' ? `共 ${posts.length} 篇文章` : `${posts.length} posts`}</p>
		</div>
		{archive.length === 0 ? (
			<p class="faint">{lang === 'zh' ? '暂无文章。' : 'No posts yet.'}</p>
		) : (
			<div style="display: flex; flex-direction: column; gap: 32px;">
				{archive.map(([year, list]) => (
					<div>
						<h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 700; letter-spacing: -0.02em;">
							{year}
						</h3>
						<div class="grid" style="grid-template-columns: 1fr;">
							{list.map((post) => (
								<div
									class="card blog-card"
									data-slug={post.slug}
									data-lang={lang}
									role="link"
									tabindex="0"
									aria-label={post.data.title}
									style="cursor: pointer;"
								>
									<div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;">
										<div style="flex: 1;">
											<h3 style="margin: 0 0 8px 0; font-size: 15px; font-weight: 600;">
												{post.data.title}
											</h3>
											{post.data.summary && (
												<p style="margin: 0 0 8px 0; font-size: 13px; color: var(--text-muted); line-height: 1.5;">
													{post.data.summary}
												</p>
											)}
											<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 12px; color: var(--text-faint);">
												<time datetime={post.data.date.toISOString()}>
													{post.data.date.toISOString().slice(0, 10)}
												</time>
												{post.data.tags.length > 0 && (
													<div class="blog-tags-container">
														{post.data.tags.map((tag) => (
															<a 
																href={`/${lang}/blog/tags/${encodeURIComponent(tag)}/`} 
																class="tag"
																title={lang === 'zh' ? `查看所有「${tag}」标签的文章` : `View all posts tagged "${tag}"`}
															>
																{tag}
															</a>
														))}
													</div>
												)}
											</div>
										</div>
									</div>
								</div>
							))}
						</div>
					</div>
				))}
			</div>
		)}
	</section>

	<script>
		// 防止标签链接触发卡片链接
		document.addEventListener('DOMContentLoaded', () => {
			document.querySelectorAll('.blog-card[data-slug]').forEach((card) => {
				const slug = card.dataset.slug;
				const lang = card.dataset.lang;
				card.addEventListener('click', (e) => {
					if (e.target.closest('.blog-tags-container')) {
						return;
					}
					window.location.href = `/${lang}/blog/${slug}/`;
				});
				card.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' || e.key === ' ') {
						e.preventDefault();
						card.click();
					}
				});
			});

			const tagLinks = document.querySelectorAll('.blog-tags-container .tag');
			tagLinks.forEach((link) => {
				link.addEventListener('click', (e) => {
					e.stopPropagation();
				});
			});
		});
	</script>
</BaseLayout>
