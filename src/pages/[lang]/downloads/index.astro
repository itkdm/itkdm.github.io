---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import type { Lang } from '../../../i18n/config';
import { SUPPORTED_LANGS } from '../../../i18n/config';
import releases from '../../../generated/releases.json';
import { renderMarkdown } from '../../../lib/markdown-render';
import DownloadSourceIcon from '../../../components/DownloadSourceIcon.astro';
import type { DownloadTool, DownloadSource, GitHubDownloadSource, CloudDiskDownloadSource } from '../../../types/downloads';

export function getStaticPaths() {
	return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params as { lang: Lang };
const tools = (releases.tools ?? []) as DownloadTool[];
const site = Astro.site?.href ?? 'https://itkdm.com';
const canonical = new URL(`/${lang}/downloads/`, site).href;
const jsonLd = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: lang === 'zh' ? '下载中心' : 'Downloads',
	description:
		lang === 'zh'
			? '下载中心 - 支持多种下载方式'
			: 'Download center - Multiple download options',
	inLanguage: lang,
	url: canonical,
};

// 获取下载源类型标签
function getSourceTypeLabel(type: string): string {
	const labels: Record<string, { zh: string; en: string }> = {
		direct: { zh: '直接下载', en: 'Direct Download' },
		github: { zh: 'GitHub Release', en: 'GitHub Release' },
		baidu: { zh: '百度网盘', en: 'Baidu Netdisk' },
		quark: { zh: '夸克网盘', en: 'Quark Netdisk' },
		aliyun: { zh: '阿里云盘', en: 'Aliyun Drive' },
		other: { zh: '其他网盘', en: 'Other Cloud Disk' },
	};
	return labels[type]?.[lang] || type;
}


// 格式化文件大小
function formatSize(bytes?: number): string {
	if (!bytes) return '';
	const mb = bytes / 1024 / 1024;
	if (mb >= 1) {
		return `${mb.toFixed(1)} MB`;
	}
	return `${(bytes / 1024).toFixed(1)} KB`;
}
---

<BaseLayout
	lang={lang}
	title={lang === 'zh' ? '下载中心' : 'Downloads'}
	description={lang === 'zh' ? '下载中心 - 支持多种下载方式' : 'Download center - Multiple download options'}
	currentPath={`/${lang}/downloads/`}
	jsonLd={jsonLd}
>
	<section class="section">
		<div class="section-head">
			<div>
				<h1>{lang === 'zh' ? '下载中心' : 'Downloads'}</h1>
			</div>
		</div>

		{tools.length > 0 && (
			<div class="download-search-container">
				<input
					type="text"
					id="downloadSearchInput"
					class="download-search-input"
					placeholder={lang === 'zh' ? '搜索应用名称、描述...' : 'Search app name, description...'}
					autocomplete="off"
					aria-label={lang === 'zh' ? '搜索下载项' : 'Search downloads'}
				/>
				<span class="download-search-count" id="downloadSearchCount"></span>
			</div>
		)}

		<div id="downloadResults">
			{tools.length === 0 ? (
				<div class="card">
					<p>{lang === 'zh' ? '暂无下载项。' : 'No download items yet.'}</p>
				</div>
			) : (
				tools.map((tool) => (
				<div class="download-card" id={tool.id}>
					<div class="download-left">
						{tool.icon && (
							<div class="app-icon" aria-hidden="true">
								<span style="font-size: 32px;">{tool.icon}</span>
							</div>
						)}
						<div style="min-width: 0; flex: 1;">
							<h2 style="margin: 0 0 8px;">
								{lang === 'zh' ? tool.name : tool.nameEn || tool.name}
							</h2>
							<p style="margin: 0 0 12px; color: var(--text-muted); font-size: 14px;">
								{lang === 'zh' ? tool.description : tool.descriptionEn || tool.description}
							</p>
							{tool.sources?.some((s) => s.type === 'github' && (s as GitHubDownloadSource).latest) && (
								<div class="dl-meta">
									<span class="tag success">
										{lang === 'zh' ? '最新版本' : 'Latest'}: {
											(tool.sources.find((s) => s.type === 'github' && (s as GitHubDownloadSource).latest) as GitHubDownloadSource | undefined)?.latest?.version || ''
										}
									</span>
								</div>
							)}
						</div>
					</div>

					<div class="download-right">
						{tool.sources && tool.sources.length > 0 ? (
							<div class="download-sources">
								{tool.sources.map((source: DownloadSource) => {
									if (source.type === 'github' && (source as GitHubDownloadSource).latest) {
										// GitHub Release 下载源
										const githubSource = source as GitHubDownloadSource;
										return (
											<div class="download-source-group">
												<div class="download-source-header">
													<DownloadSourceIcon type="github" />
													<span class="source-label">{getSourceTypeLabel('github')}</span>
													{githubSource.latest?.publishedAt && (
														<span class="source-meta">
															<time datetime={githubSource.latest.publishedAt}>
																{new Date(githubSource.latest.publishedAt).toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US')}
															</time>
														</span>
													)}
												</div>
												{githubSource.latest?.assets && githubSource.latest.assets.length > 0 ? (
													<div class="download-buttons">
														{githubSource.latest.assets.map((asset) => (
															<a
																href={asset.downloadUrl}
																class="btn btn-primary"
																target="_blank"
																rel="noopener noreferrer"
															>
																<span class="dot"></span>
																<span>{asset.name}</span>
															</a>
														))}
													</div>
												) : (
													<p class="meta" style="margin: 8px 0 0;">
														{lang === 'zh' ? '暂无可用资产' : 'No assets available'}
													</p>
												)}
												{githubSource.latest?.notes && (
													<details class="release-notes" style="margin-top: 12px;">
														<summary style="cursor: pointer; color: var(--text-muted); font-size: 13px;">
															{lang === 'zh' ? '查看更新日志' : 'View Release Notes'}
														</summary>
														<div
															class="release-notes-content"
															style="margin-top: 8px; padding: 12px; background: var(--bg-soft); border-radius: 8px; font-size: 13px; line-height: 1.6;"
															set:html={renderMarkdown(githubSource.latest.notes)}
														></div>
													</details>
												)}
											</div>
										);
									} else if (source.type === 'direct') {
										// 直接下载链接
										const directSource = source as import('../../../types/downloads').DirectDownloadSource;
										return (
											<div class="download-source-group">
												<div class="download-buttons">
													<a
														href={directSource.url}
														class="btn btn-primary"
														target="_blank"
														rel="noopener noreferrer"
														download
													>
														<DownloadSourceIcon type="direct" />
														<span>{directSource.name || (lang === 'zh' ? '直接下载' : 'Direct Download')}</span>
													</a>
												</div>
											</div>
										);
									} else if (['baidu', 'quark', 'aliyun', 'other'].includes(source.type)) {
										// 网盘链接 - 点击复制链接
										const cloudSource = source as CloudDiskDownloadSource;
										const sourceName = cloudSource.name || getSourceTypeLabel(cloudSource.type);
										return (
											<div class="download-source-group">
												<div class="download-buttons">
													<button
														type="button"
														class="btn btn-primary copy-link-btn"
														data-url={cloudSource.url}
														data-code={cloudSource.code || ''}
														data-lang={lang}
													>
														<DownloadSourceIcon type={cloudSource.type} />
														<span class="copy-link-text">{sourceName}</span>
														<span class="copy-link-success" style="display: none;">
															{lang === 'zh' ? '✓ 已复制' : '✓ Copied'}
														</span>
													</button>
												</div>
											</div>
										);
									}
									return null;
								})}
							</div>
						) : (
							<p class="meta">{lang === 'zh' ? '暂无下载源' : 'No download sources'}</p>
						)}
					</div>
				</div>
			))
		)}
		</div>

		{tools.length > 0 && (
			<div class="download-no-results" id="downloadNoResults" style="display: none;">
				<p>{lang === 'zh' ? '未找到匹配的下载项' : 'No matching download items found'}</p>
			</div>
		)}
	</section>

	<style>
		.download-card {
			padding: 20px 0;
			border-bottom: 1px solid var(--border);
			margin-bottom: 20px;
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.download-card:last-child {
			border-bottom: none;
			margin-bottom: 0;
		}

		.download-left {
			display: flex;
			gap: 16px;
			align-items: flex-start;
		}

		.app-icon {
			width: 56px;
			height: 56px;
			border-radius: 16px;
			border: 1px solid var(--border);
			background: radial-gradient(
					16px 16px at 30% 30%,
					rgba(255, 255, 255, 0.9),
					rgba(255, 255, 255, 0.22) 60%,
					transparent 62%
				),
				linear-gradient(
					135deg,
					color-mix(in srgb, var(--primary) 80%, #000 0%),
					color-mix(in srgb, var(--accent) 70%, var(--primary) 30%)
				);
			box-shadow: 0 16px 30px rgba(6, 43, 54, 0.18);
			flex: 0 0 auto;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		[data-theme='dark'] .app-icon {
			box-shadow: 0 16px 34px rgba(0, 0, 0, 0.48);
		}

		.dl-meta {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
			margin-top: 10px;
		}

		.download-right {
			display: flex;
			flex-direction: column;
			gap: 16px;
			width: 100%;
		}

		.download-sources {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			width: 100%;
		}

		.download-source-group {
			display: flex;
			flex-direction: column;
			gap: 6px;
			flex: 0 0 auto;
		}

		.download-source-header {
			display: flex;
			align-items: center;
			gap: 6px;
			font-size: 12px;
			color: var(--text-muted);
			margin-bottom: 4px;
		}

		.source-icon {
			font-size: 16px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}

		.source-icon .download-icon {
			width: 16px;
			height: 16px;
			color: var(--text-muted);
		}

		.source-label {
			font-weight: 600;
			color: var(--text);
		}

		.source-meta {
			margin-left: auto;
			font-size: 12px;
		}

		.download-buttons {
			display: flex;
			flex-direction: column;
			gap: 6px;
			align-items: flex-start;
		}

		.download-buttons .btn {
			width: auto;
			min-width: 120px;
			max-width: 100%;
			justify-content: center;
			transition: border-color 0.18s ease, background 0.18s ease, color 0.18s ease;
			display: inline-flex;
			align-items: center;
			gap: 6px;
		}
		
		.download-buttons .btn .source-icon {
			flex-shrink: 0;
		}
		
		.download-buttons .btn .download-icon {
			width: 16px;
			height: 16px;
			flex-shrink: 0;
		}

		.download-buttons .btn:hover {
			transform: none;
			box-shadow: 0 1px 0 rgba(255, 255, 255, 0.4) inset;
		}

		.download-buttons .btn:active {
			transform: none;
		}

		.release-notes {
			font-size: 13px;
		}

		.release-notes-content {
			white-space: pre-wrap;
			word-break: break-word;
		}

		@media (max-width: 768px) {
			.download-sources {
				flex-direction: column;
			}
		}

		.copy-link-btn {
			position: relative;
		}

		.copy-link-success {
			color: var(--success);
		}

		.download-search-container {
			position: relative;
			margin-bottom: 2rem;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 1rem;
		}

		.download-search-input {
			width: 100%;
			max-width: 500px;
			padding: 0.75rem 1rem;
			padding-left: 2.5rem;
			border: 1px solid var(--border);
			border-radius: 8px;
			background: var(--bg);
			color: var(--text);
			font-size: 0.95rem;
			transition: all 0.2s;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%235B6470' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: 0.75rem center;
			background-size: 1rem;
		}

		.download-search-input:focus {
			outline: none;
			border-color: var(--accent);
			box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 16%, transparent);
		}

		.download-search-count {
			font-size: 0.875rem;
			color: var(--text-muted);
			white-space: nowrap;
		}

		@media (max-width: 768px) {
			.download-search-container {
				flex-direction: column;
				align-items: center;
			}

			.download-search-input {
				max-width: 100%;
			}

			.download-search-count {
				text-align: center;
			}
		}

		.download-no-results {
			text-align: center;
			padding: 3rem 1rem;
			color: var(--text-muted);
		}
	</style>

	<script>
		// 复制网盘链接功能
		document.addEventListener('DOMContentLoaded', () => {
			const copyButtons = document.querySelectorAll('.copy-link-btn');
			
			copyButtons.forEach((btn) => {
				btn.addEventListener('click', async () => {
					const url = btn.getAttribute('data-url');
					const code = btn.getAttribute('data-code');
					const lang = btn.getAttribute('data-lang');
					
					// 构建要复制的文本
					let textToCopy = url;
					if (code) {
						const codeLabel = lang === 'zh' ? '提取码' : 'Extraction Code';
						textToCopy = `${url}\n${codeLabel}: ${code}`;
					}
					
					try {
						// 使用 Clipboard API 复制
						await navigator.clipboard.writeText(textToCopy);
						
						// 显示成功提示
						const textSpan = btn.querySelector('.copy-link-text');
						const successSpan = btn.querySelector('.copy-link-success');
						
						if (textSpan && successSpan) {
							textSpan.style.display = 'none';
							successSpan.style.display = 'inline';
							
							// 1.5秒后恢复原状
							setTimeout(() => {
								textSpan.style.display = 'inline';
								successSpan.style.display = 'none';
							}, 1500);
						}
					} catch (err) {
						// 如果 Clipboard API 不可用，使用 fallback 方法
						const textarea = document.createElement('textarea');
						textarea.value = textToCopy;
						textarea.style.position = 'fixed';
						textarea.style.opacity = '0';
						document.body.appendChild(textarea);
						textarea.select();
						
						try {
							document.execCommand('copy');
							
							// 显示成功提示
							const textSpan = btn.querySelector('.copy-link-text');
							const successSpan = btn.querySelector('.copy-link-success');
							
							if (textSpan && successSpan) {
								textSpan.style.display = 'none';
								successSpan.style.display = 'inline';
								
								setTimeout(() => {
									textSpan.style.display = 'inline';
									successSpan.style.display = 'none';
								}, 1500);
							}
						} catch (fallbackErr) {
							console.error('Failed to copy:', fallbackErr);
							alert(lang === 'zh' ? '复制失败，请手动复制链接' : 'Copy failed, please copy manually');
						}
						
						document.body.removeChild(textarea);
					}
				});
			});
		});

		// 下载搜索功能
		(function() {
			const searchInput = document.getElementById('downloadSearchInput') as HTMLInputElement;
			const resultsContainer = document.getElementById('downloadResults');
			const noResultsMsg = document.getElementById('downloadNoResults');
			const searchCount = document.getElementById('downloadSearchCount');

			if (!searchInput || !resultsContainer) return;

			const downloadCards = Array.from(document.querySelectorAll('.download-card'));
			const totalCount = downloadCards.length;

			function updateSearchCount(count: number) {
				if (searchCount) {
					searchCount.textContent = `${count} / ${totalCount}`;
				}
			}

			function performSearch() {
				const query = searchInput.value.trim().toLowerCase();
				let visibleCount = 0;

				if (!query) {
					downloadCards.forEach((card) => {
						(card as HTMLElement).style.display = '';
						visibleCount++;
					});
					if (noResultsMsg) (noResultsMsg as HTMLElement).style.display = 'none';
					updateSearchCount(visibleCount);
					return;
				}

				downloadCards.forEach((card) => {
					const cardElement = card as HTMLElement;
					const cardText = cardElement.textContent?.toLowerCase() || '';

					if (cardText.includes(query)) {
						cardElement.style.display = '';
						visibleCount++;
					} else {
						cardElement.style.display = 'none';
					}
				});

				if (noResultsMsg) {
					(noResultsMsg as HTMLElement).style.display = visibleCount === 0 ? 'block' : 'none';
				}

				updateSearchCount(visibleCount);
			}

			searchInput.addEventListener('input', performSearch);

			// 支持键盘快捷键：Ctrl/Cmd + K 聚焦搜索框
			document.addEventListener('keydown', (e) => {
				if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
					e.preventDefault();
					searchInput.focus();
				}
			});

			// 初始显示总数
			updateSearchCount(totalCount);
		})();
	</script>
</BaseLayout>
